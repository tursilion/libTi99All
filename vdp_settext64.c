#include "vdp.h"

// TODO: text modes should not rely on conio support if possible...
extern unsigned int conio_scrnCol; // conio_bgcolor.c

int text64_scroll = 0;

static void fast_scrn_scroll64();

// This is a full 256 byte character set...
const unsigned char font3x5[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x44,0xAA,0xAA,0xAA,0xAA,0xAA,0x44,0x00, 0x44,0xEE,0xEE,0xEE,0xEE,0xEE,0x44,0x00, 0x00,0x00,0xAA,0xEE,0xEE,0x44,0x00,0x00,
0x00,0x00,0x44,0xEE,0xEE,0x44,0x00,0x00, 0x00,0x00,0x44,0xEE,0xAA,0x44,0x44,0x00, 0x00,0x00,0x44,0xEE,0xEE,0x44,0xEE,0x00, 0x00,0x00,0x00,0x44,0xEE,0x44,0x00,0x00,
0xEE,0xEE,0xAA,0x00,0x00,0xAA,0xEE,0xEE, 0x00,0x00,0x00,0x44,0xAA,0x44,0x00,0x00, 0xEE,0xEE,0xEE,0xAA,0x44,0xAA,0xEE,0xEE, 0x00,0x33,0x11,0x44,0xAA,0xAA,0x44,0x00,
0x00,0x44,0xAA,0xAA,0x44,0xEE,0x44,0x00, 0x00,0x63,0x42,0x42,0xC6,0xC6,0x00,0x00, 0x00,0x66,0x55,0x55,0xDD,0xDD,0x33,0x33, 0x00,0xAA,0x44,0xAA,0x44,0xAA,0x00,0x00,
0x00,0x88,0xCC,0xEE,0xCC,0x88,0x00,0x00, 0x00,0x22,0x66,0xEE,0x66,0x22,0x00,0x00, 0x00,0x44,0xEE,0x44,0xEE,0x44,0x00,0x00, 0xAA,0xAA,0xAA,0xAA,0x00,0xAA,0x00,0x00,
0x00,0x77,0xDD,0xDD,0x55,0x55,0x00,0x00, 0x66,0x88,0x44,0xAA,0x44,0x22,0xCC,0x00, 0x00,0x00,0x00,0x00,0xEE,0xEE,0x00,0x00, 0x44,0xEE,0x44,0x44,0xEE,0x44,0xEE,0x00,
0x00,0x44,0xEE,0x55,0x44,0x44,0x44,0x00, 0x00,0x44,0x44,0x44,0x55,0xEE,0x44,0x00, 0x00,0x44,0x22,0xFF,0x22,0x44,0x00,0x00, 0x00,0x22,0x44,0xFF,0x44,0x22,0x00,0x00,
0x00,0x00,0x88,0x88,0xEE,0x00,0x00,0x00, 0x00,0x00,0xAA,0xFF,0xAA,0x00,0x00,0x00, 0x00,0x00,0x44,0x44,0xEE,0xEE,0x00,0x00, 0x00,0x00,0xEE,0xEE,0x44,0x44,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x44,0x44,0x44,0x00,0x44,0x00,0x00, 0x00,0xAA,0xAA,0x00,0x00,0x00,0x00,0x00, 0x00,0xAA,0xFF,0xAA,0xFF,0xAA,0x00,0x00, // 32
0x44,0xEE,0x88,0x44,0x22,0xEE,0x44,0x00, 0x00,0x88,0x22,0x44,0x88,0x22,0x00,0x00, 0x00,0x44,0xAA,0x44,0xAA,0x55,0x00,0x00, 0x00,0x44,0x88,0x00,0x00,0x00,0x00,0x00,
0x00,0x22,0x44,0x44,0x44,0x22,0x00,0x00, 0x00,0x88,0x44,0x44,0x44,0x88,0x00,0x00, 0x00,0xAA,0x44,0xEE,0x44,0xAA,0x00,0x00, 0x00,0x00,0x44,0xEE,0x44,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x44,0x88,0x00, 0x00,0x00,0x00,0xEE,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x44,0x00,0x00, 0x00,0x22,0x22,0x44,0x88,0x88,0x00,0x00,
0x00,0x44,0xAA,0xAA,0xAA,0x44,0x00,0x00, 0x00,0x44,0xCC,0x44,0x44,0xEE,0x00,0x00, 0x00,0xCC,0x22,0x44,0x88,0xEE,0x00,0x00, 0x00,0xCC,0x22,0x44,0x22,0xCC,0x00,0x00,
0x00,0xAA,0xAA,0xEE,0x22,0x22,0x00,0x00, 0x00,0xEE,0x88,0xCC,0x22,0xCC,0x00,0x00, 0x00,0x66,0x88,0xCC,0xAA,0x44,0x00,0x00, 0x00,0xEE,0x22,0x44,0x88,0x88,0x00,0x00,
0x00,0x44,0xAA,0x44,0xAA,0x44,0x00,0x00, 0x00,0x44,0xAA,0x66,0x22,0x44,0x00,0x00, 0x00,0x00,0x00,0x44,0x00,0x44,0x00,0x00, 0x00,0x00,0x00,0x44,0x00,0x44,0x88,0x00,
0x00,0x22,0x44,0x88,0x44,0x22,0x00,0x00, 0x00,0x00,0xEE,0x00,0xEE,0x00,0x00,0x00, 0x00,0x88,0x44,0x22,0x44,0x88,0x00,0x00, 0x44,0xAA,0x22,0x44,0x00,0x44,0x00,0x00,
0x00,0x44,0xAA,0xEE,0xEE,0x88,0x44,0x00, 0x00,0x44,0xAA,0xEE,0xAA,0xAA,0x00,0x00, 0x00,0xCC,0xAA,0xCC,0xAA,0xCC,0x00,0x00, 0x00,0x66,0x88,0x88,0x88,0x66,0x00,0x00,
0x00,0xCC,0xAA,0xAA,0xAA,0xCC,0x00,0x00, 0x00,0xEE,0x88,0xCC,0x88,0xEE,0x00,0x00, 0x00,0xEE,0x88,0xCC,0x88,0x88,0x00,0x00, 0x00,0x66,0x88,0xAA,0xAA,0x66,0x00,0x00,
0x00,0xAA,0xAA,0xEE,0xAA,0xAA,0x00,0x00, 0x00,0xEE,0x44,0x44,0x44,0xEE,0x00,0x00, 0x00,0x22,0x22,0x22,0xAA,0xEE,0x00,0x00, 0x00,0xAA,0xAA,0xCC,0xAA,0xAA,0x00,0x00,
0x00,0x88,0x88,0x88,0x88,0xEE,0x00,0x00, 0x00,0xAA,0xEE,0xEE,0xAA,0xAA,0x00,0x00, 0x00,0xCC,0xAA,0xAA,0xAA,0xAA,0x00,0x00, 0x00,0x66,0xAA,0xAA,0xAA,0xCC,0x00,0x00,
0x00,0xCC,0xAA,0xCC,0x88,0x88,0x00,0x00, 0x00,0x66,0xAA,0xAA,0xAA,0xCC,0x22,0x00, 0x00,0xCC,0xAA,0xCC,0xAA,0xAA,0x00,0x00, 0x00,0x66,0x88,0x44,0x22,0xCC,0x00,0x00,
0x00,0xEE,0x44,0x44,0x44,0x44,0x00,0x00, 0x00,0xAA,0xAA,0xAA,0xAA,0xEE,0x00,0x00, 0x00,0xAA,0xAA,0xAA,0x44,0x44,0x00,0x00, 0x00,0xAA,0xAA,0xEE,0xEE,0xAA,0x00,0x00,
0x00,0xAA,0xAA,0x44,0xAA,0xAA,0x00,0x00, 0x00,0xAA,0xAA,0x44,0x44,0x44,0x00,0x00, 0x00,0xEE,0x22,0x44,0x88,0xEE,0x00,0x00, 0x00,0x66,0x44,0x44,0x44,0x66,0x00,0x00,
0x00,0x88,0x88,0x44,0x22,0x22,0x00,0x00, 0x00,0xCC,0x44,0x44,0x44,0xCC,0x00,0x00, 0x00,0x44,0xAA,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0xEE,0x00,0x00,
0x00,0x44,0x22,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x66,0xAA,0xAA,0x66,0x00,0x00, 0x88,0x88,0xCC,0xAA,0xAA,0xCC,0x00,0x00, 0x00,0x00,0x66,0x88,0x88,0x66,0x00,0x00,
0x22,0x22,0x66,0xAA,0xAA,0x66,0x00,0x00, 0x00,0x00,0x66,0xAA,0xCC,0x66,0x00,0x00, 0x66,0x44,0xEE,0x44,0x44,0x44,0x00,0x00, 0x00,0x00,0x66,0xAA,0xAA,0x66,0x22,0xCC,
0x88,0x88,0xEE,0xAA,0xAA,0xAA,0x00,0x00, 0x44,0x00,0x44,0x44,0x44,0x44,0x00,0x00, 0x22,0x00,0x22,0x22,0x22,0xAA,0x44,0x00, 0x88,0x88,0xAA,0xCC,0xCC,0xAA,0x00,0x00,
0x44,0x44,0x44,0x44,0x44,0x44,0x00,0x00, 0x00,0x00,0xEE,0xEE,0xAA,0xAA,0x00,0x00, 0x00,0x00,0xCC,0xAA,0xAA,0xAA,0x00,0x00, 0x00,0x00,0x44,0xAA,0xAA,0x44,0x00,0x00,
0x00,0x00,0xCC,0xAA,0xAA,0xCC,0x88,0x88, 0x00,0x00,0x66,0xAA,0xAA,0x66,0x22,0x22, 0x00,0x00,0xAA,0xCC,0x88,0x88,0x00,0x00, 0x00,0x00,0x66,0xCC,0x22,0xCC,0x00,0x00,
0x00,0x44,0xEE,0x44,0x44,0x44,0x00,0x00, 0x00,0x00,0xAA,0xAA,0xAA,0xEE,0x00,0x00, 0x00,0x00,0xAA,0xAA,0xAA,0x44,0x00,0x00, 0x00,0x00,0xAA,0xAA,0xEE,0xEE,0x00,0x00,
0x00,0x00,0xAA,0x44,0x44,0xAA,0x00,0x00, 0x00,0x00,0xAA,0xAA,0xAA,0x66,0x22,0xCC, 0x00,0x00,0xEE,0x66,0x88,0xEE,0x00,0x00, 0x00,0x66,0x44,0x88,0x44,0x66,0x00,0x00,
0x00,0x44,0x44,0x00,0x44,0x44,0x00,0x00, 0x00,0xCC,0x44,0x22,0x44,0xCC,0x00,0x00, 0x00,0x66,0xCC,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x44,0xAA,0xEE,0x00,0x00,0x00,
0x66,0x88,0x88,0x88,0x66,0x22,0x66,0x00, 0xAA,0x00,0xAA,0xAA,0xAA,0xEE,0x00,0x00, 0x22,0x44,0x66,0xAA,0xCC,0x66,0x00,0x00, 0x44,0xAA,0x66,0xAA,0xAA,0x66,0x00,0x00,
0xAA,0x00,0x66,0xAA,0xAA,0x66,0x00,0x00, 0x88,0x44,0x66,0xAA,0xAA,0x66,0x00,0x00, 0x44,0x00,0x66,0xAA,0xAA,0x66,0x00,0x00, 0x00,0x00,0x66,0x88,0x88,0x66,0x22,0x66,
0x44,0xAA,0x66,0xAA,0xCC,0x66,0x00,0x00, 0xAA,0x00,0x66,0xAA,0xCC,0x66,0x00,0x00, 0x88,0x44,0x66,0xAA,0xCC,0x66,0x00,0x00, 0xAA,0x00,0x44,0x44,0x44,0x44,0x00,0x00,
0x44,0xAA,0x00,0x44,0x44,0x44,0x00,0x00, 0x88,0x44,0x00,0x44,0x44,0x44,0x00,0x00, 0xAA,0x44,0xAA,0xEE,0xAA,0xAA,0x00,0x00, 0x44,0xAA,0x44,0xAA,0xEE,0xAA,0x00,0x00,
0x44,0xEE,0x88,0xCC,0x88,0xEE,0x00,0x00, 0x00,0x00,0x77,0xBB,0xAA,0x77,0x00,0x00, 0x00,0x77,0xAA,0xFF,0xAA,0xBB,0x00,0x00, 0x44,0xAA,0x44,0xAA,0xAA,0x44,0x00,0x00,
0xAA,0x00,0x44,0xAA,0xAA,0x44,0x00,0x00, 0x88,0x44,0x44,0xAA,0xAA,0x44,0x00,0x00, 0x44,0xAA,0x00,0xAA,0xAA,0xEE,0x00,0x00, 0x88,0x44,0x00,0xAA,0xAA,0xEE,0x00,0x00,
0xAA,0x00,0xAA,0xAA,0xAA,0x66,0x22,0xCC, 0xAA,0x00,0x66,0xAA,0xAA,0xCC,0x00,0x00, 0xAA,0x00,0xAA,0xAA,0xAA,0xAA,0xEE,0x00, 0x00,0x44,0xEE,0x88,0xEE,0x44,0x00,0x00,
0x22,0x44,0xEE,0x44,0xCC,0x66,0x00,0x00, 0xAA,0xAA,0x44,0xEE,0x44,0xEE,0x44,0x00, 0xCC,0xAA,0xCC,0xAA,0xFF,0xAA,0x00,0x00, 0x66,0x44,0xEE,0x44,0x44,0x44,0x88,0x00,
0x22,0x44,0x66,0xAA,0xAA,0x66,0x00,0x00, 0x22,0x44,0x00,0x44,0x44,0x44,0x00,0x00, 0x22,0x44,0x44,0xAA,0xAA,0x44,0x00,0x00, 0x22,0x44,0x00,0xAA,0xAA,0xEE,0x00,0x00,
0x66,0xCC,0x00,0xCC,0xAA,0xAA,0x00,0x00, 0xEE,0x00,0xCC,0xAA,0xAA,0xAA,0x00,0x00, 0x66,0xAA,0x66,0x00,0x00,0x00,0x00,0x00, 0x44,0xAA,0x44,0x00,0x00,0x00,0x00,0x00,
0x44,0x00,0x44,0x88,0xAA,0x44,0x00,0x00, 0x00,0x00,0x00,0xEE,0x88,0x00,0x00,0x00, 0x00,0x00,0x00,0xEE,0x22,0x00,0x00,0x00, 0x88,0x88,0xAA,0x44,0xBB,0x11,0x22,0x33,
0x88,0x88,0xAA,0x44,0x88,0x55,0x77,0x11, 0x00,0x44,0x00,0x44,0x44,0x44,0x00,0x00, 0x00,0x00,0x55,0xAA,0x55,0x00,0x00,0x00, 0x00,0x00,0xAA,0x55,0xAA,0x00,0x00,0x00,
0x00,0x55,0x00,0xAA,0x00,0x55,0x00,0xAA, 0x55,0xAA,0x55,0xAA,0x55,0xAA,0x55,0xAA, 0xFF,0xAA,0xFF,0x55,0xFF,0xAA,0xFF,0x55, 0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,
0x44,0x44,0x44,0xCC,0x44,0x44,0x44,0x44, 0x44,0x44,0xCC,0x44,0xCC,0x44,0x44,0x44, 0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA, 0x00,0x00,0x00,0xEE,0xAA,0xAA,0xAA,0xAA,
0x00,0x00,0xCC,0x44,0xCC,0x44,0x44,0x44, 0xAA,0xAA,0xAA,0x22,0xAA,0xAA,0xAA,0xAA, 0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA, 0x00,0x00,0xEE,0x22,0xAA,0xAA,0xAA,0xAA,
0xAA,0xAA,0xAA,0x22,0xEE,0x00,0x00,0x00, 0xAA,0xAA,0xAA,0xEE,0x00,0x00,0x00,0x00, 0x44,0x44,0xCC,0x44,0xCC,0x00,0x00,0x00, 0x00,0x00,0x00,0xCC,0x44,0x44,0x44,0x44,
0x44,0x44,0x44,0x77,0x00,0x00,0x00,0x00, 0x44,0x44,0x44,0xFF,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0xFF,0x44,0x44,0x44,0x44, 0x44,0x44,0x44,0x77,0x44,0x44,0x44,0x44,
0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00, 0x44,0x44,0x44,0xFF,0x44,0x44,0x44,0x44, 0x44,0x44,0x77,0x44,0x77,0x00,0x00,0x00, 0xAA,0xAA,0xAA,0xBB,0xAA,0xAA,0xAA,0xAA,
0xAA,0xAA,0xBB,0x88,0xFF,0x00,0x00,0x00, 0x00,0x00,0xFF,0x88,0xBB,0xAA,0xAA,0xAA, 0xAA,0xAA,0xBB,0x00,0xFF,0x00,0x00,0x00, 0x00,0x00,0xFF,0x00,0xBB,0xAA,0xAA,0xAA,
0xAA,0xAA,0xBB,0x88,0xBB,0xAA,0xAA,0xAA, 0x00,0x00,0xFF,0x00,0xFF,0x00,0x00,0x00, 0xAA,0xAA,0xBB,0x00,0xBB,0xAA,0xAA,0xAA, 0x44,0x44,0xFF,0x00,0xFF,0x00,0x00,0x00,
0xAA,0xAA,0xAA,0xFF,0x00,0x00,0x00,0x00, 0x00,0x00,0xFF,0x00,0xFF,0x44,0x44,0x44, 0x00,0x00,0x00,0xFF,0xAA,0xAA,0xAA,0xAA, 0xAA,0xAA,0xAA,0xFF,0x00,0x00,0x00,0x00,
0x44,0x44,0x77,0x44,0x77,0x00,0x00,0x00, 0x00,0x00,0x77,0x44,0x77,0x44,0x44,0x44, 0x00,0x00,0x00,0xFF,0xAA,0xAA,0xAA,0xAA, 0xAA,0xAA,0xAA,0xFF,0xAA,0xAA,0xAA,0xAA,
0x44,0x44,0xFF,0x44,0xFF,0x44,0x44,0x44, 0x44,0x44,0x44,0xCC,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x77,0x44,0x44,0x44,0x44, 0xEE,0xEE,0xEE,0xEE,0xEE,0xEE,0xEE,0xEE,
0x00,0x00,0x00,0x00,0xEE,0xEE,0xEE,0xEE, 0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC, 0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x66, 0xEE,0xEE,0xEE,0xEE,0x00,0x00,0x00,0x00,
0x00,0x00,0x55,0xAA,0xAA,0x55,0x00,0x00, 0x00,0x44,0xAA,0xCC,0xAA,0xAA,0xCC,0x00, 0x00,0xEE,0xAA,0x88,0x88,0x88,0x00,0x00, 0x00,0x00,0x00,0xEE,0xAA,0xAA,0x00,0x00,
0x00,0xEE,0x88,0x44,0x88,0xEE,0x00,0x00, 0x00,0x00,0x77,0xAA,0xAA,0x44,0x00,0x00, 0x00,0x00,0xAA,0xAA,0xEE,0x88,0x00,0x00, 0x00,0x00,0xEE,0x44,0x44,0x22,0x00,0x00,
0xEE,0x44,0xEE,0xAA,0xEE,0x44,0xEE,0x00, 0x00,0x44,0xAA,0xEE,0xAA,0x44,0x00,0x00, 0x00,0xEE,0xAA,0xAA,0xEE,0x44,0xEE,0x00, 0x00,0x66,0x44,0xAA,0xAA,0x44,0x00,0x00,
0x00,0x00,0x66,0x99,0x66,0x00,0x00,0x00, 0x00,0x44,0x44,0xAA,0xAA,0x44,0x44,0x00, 0x00,0x66,0x88,0x44,0x88,0x66,0x00,0x00, 0x00,0x00,0x00,0x44,0xAA,0xAA,0x00,0x00,
0x00,0xEE,0x00,0xEE,0x00,0xEE,0x00,0x00, 0x00,0x44,0xEE,0x44,0x00,0xEE,0x00,0x00, 0x00,0x88,0x44,0x22,0x44,0x88,0xEE,0x00, 0x00,0x22,0x44,0x88,0x44,0x22,0xEE,0x00,
0x00,0x22,0x55,0x44,0x44,0x44,0x44,0x44, 0x22,0x22,0x22,0x22,0x22,0xAA,0x44,0x00, 0x00,0x44,0x00,0xEE,0x00,0x44,0x00,0x00, 0x00,0x66,0xCC,0x00,0x66,0xCC,0x00,0x00,
0x44,0xAA,0x44,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x66,0x66,0x00,0x00,0x00, 0x00,0x00,0x00,0x44,0x00,0x00,0x00,0x00, 0x00,0x33,0x22,0x22,0xAA,0x44,0x00,0x00,
0xCC,0xAA,0xAA,0x00,0x00,0x00,0x00,0x00, 0xCC,0x44,0x88,0xCC,0x00,0x00,0x00,0x00, 0x00,0x00,0xEE,0xEE,0xEE,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};

void vdpchar64(int pAddr, unsigned char ch)
{
#ifdef TI99
    static unsigned short buf[4];
#else
    static unsigned char buf[8];
#endif
    extern int text64_scroll;
    static unsigned int last_offset = 0xffff;
    unsigned int offset;

    if (pAddr > 1536) pAddr-=gImage;    // don't include gImage
    offset = pAddr / 2 ; // byte offset
    offset = (offset & 0xff1f) + ((offset + text64_scroll) & 0x00e0);
    offset = offset * 8 + gPattern;
    if (offset != last_offset) {
        vdpmemread(offset, (unsigned char*) buf, 8);
        last_offset = offset;
    }

#ifdef TI99
    // this is the only big endian, 16-bit machine in the list
    unsigned short mask = pAddr & 1 ? 0xf0f0 : 0x0f0f, mask2 = ~mask;
    const unsigned short *font = ((unsigned short*)font3x5) + ch*4;
    buf[0] = (buf[0] & mask) | (*(font++) & mask2);
    buf[1] = (buf[1] & mask) | (*(font++) & mask2);
    buf[2] = (buf[2] & mask) | (*(font++) & mask2);
    buf[3] = (buf[3] & mask) | (*(font++) & mask2);
#else
    // everyone else is little endian, and most are 8 bit
    // Even the 32-bit machines are faster, so we'll do this byte wise
    unsigned char mask = pAddr & 1 ? 0xf0 : 0x0f, mask2 = ~mask;
    const unsigned char *font = font3x5 + ch*8;
    buf[0] = (buf[0] & mask) | (*(font++) & mask2);
    buf[1] = (buf[1] & mask) | (*(font++) & mask2);
    buf[2] = (buf[2] & mask) | (*(font++) & mask2);
    buf[3] = (buf[3] & mask) | (*(font++) & mask2);
    buf[4] = (buf[4] & mask) | (*(font++) & mask2);
    buf[5] = (buf[5] & mask) | (*(font++) & mask2);
    buf[6] = (buf[6] & mask) | (*(font++) & mask2);
    buf[7] = (buf[7] & mask) | (*(font++) & mask2);
#endif
    vdpmemcpy(offset, (unsigned char*) buf, 8);

    vdpmemset(offset - gPattern + gColor, conio_scrnCol, 8);
}

extern unsigned char vdp_bigbuf[256];

void fast_scrn_scroll64() {
    // similar to the slow_scrn_scroll, but uses a larger fixed
    // buffer for far more speed
    extern unsigned int conio_scrnCol; // conio_bgcolor.c
    extern int text64_scroll;
    int src, dst, ch;

    src = (8*32 + text64_scroll) * 8; // source = first middle
    dst = (0*32 + text64_scroll) * 8; // dest = last top

    text64_scroll = (text64_scroll + 0x20) & 0x00e0;
    ch = text64_scroll;

    vdpwriteinc(gImage, ch, 7*32);
    ch+=7*32;

    // copy 32 patterns from middle to top
    vdpmemread(gPattern + src, vdp_bigbuf, 256);
    vdpmemcpy(gPattern + dst, vdp_bigbuf, 256);
    vdpmemread(gColor + src, vdp_bigbuf, 256);
    vdpmemcpy(gColor + dst, vdp_bigbuf, 256);

    vdpwriteinc(gImage+7*32, ch, 8*32);
    ch+=8*32;

    // copy 32 patterns from bottom to middle
    src += 8*32*8;
    dst += 8*32*8;
    vdpmemread(gPattern + src, vdp_bigbuf, 256);
    vdpmemcpy(gPattern + dst, vdp_bigbuf, 256);
    vdpmemread(gColor + src, vdp_bigbuf, 256);
    vdpmemcpy(gColor + dst, vdp_bigbuf, 256);

    vdpwriteinc(gImage+15*32, ch, 9*32);

    // clear the last line
    dst += 8*32*8;
    vdpmemset(gPattern + dst, 0, 256);
    vdpmemset(gColor + dst, conio_scrnCol, 256);

    return;
}

unsigned char set_text64_raw(void) {
    extern unsigned int conio_scrnCol; // conio_bgcolor.c

	// note: no masking, full size bitmap mode
	unsigned char unblank = VDP_MODE1_16K | VDP_MODE1_UNBLANK | VDP_MODE1_INT;

	scrn_scroll = fast_scrn_scroll64;

	VDP_SET_REGISTER(VDP_REG_MODE1, VDP_MODE1_16K);		// no need to OR in the sprite mode for now
	VDP_SET_REGISTER(VDP_REG_MODE0, VDP_MODE0_BITMAP);
	VDP_SET_REGISTER(VDP_REG_SIT, 0x0E);	gImage = 0x3800;
	VDP_SET_REGISTER(VDP_REG_CT, 0xFF);		gColor = 0x2000;
	VDP_SET_REGISTER(VDP_REG_PDT, 0x03);	gPattern = 0x0000;
	VDP_SET_REGISTER(VDP_REG_SAL, 0x76);	gSprite = 0x3B00;	vdpchar(gSprite, 0xd0);
	VDP_SET_REGISTER(VDP_REG_SDT, 0x03);	gSpritePat = 0x1800;
	nTextRow = 64*23;
	nTextEnd = 64*24-1;
	nTextPos = nTextRow;
	nTextFlags = TEXT_FLAG_IS_BITMAPPED | TEXT_FLAG_HAS_ATTRIBUTES | TEXT_WIDTH_64 | TEXT_CUSTOM_VSETCHAR;
    vsetchar = vdpchar64;

	int i;
    VDP_SET_ADDRESS_WRITE(gImage);
	for (i = 0; i < 32*24; i++) {
        VDPWD(i);
	}

	vdpmemset(gPattern, 0, 32*24*8);
	vdpmemset(gColor, conio_scrnCol, 32*24*8);

	return unblank;
}

void set_text64_color(void) {
    unsigned char x = set_text64_raw();
    VDP_SET_REGISTER(VDP_REG_MODE1, x);
    VDP_REG1_KSCAN_MIRROR = x;
}
